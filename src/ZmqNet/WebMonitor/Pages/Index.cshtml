@page
@using Agebull.ZeroNet.Core
@using Newtonsoft.Json
@model IndexModel
@{
    ViewData["Title"] = "ZeroNet Monitor";
}
@section Styles{

    <style>
        .item {
            margin-top: 10px;
            margin-right: 40px;
        }
    </style>
}
@section Scripts{

    <script>
        var data ={
            configs: @(Html.Raw(JsonConvert.SerializeObject(ZeroApplication.Config.GetConfigs().OrderBy(p=>p.StationType).ToArray())))
        };
        var vm = new Vue({
            el: '#vue',
            data: data,
            filters: {
                formatDate(time) {
                    var date = new Date(time);
                    return formatDate(date, 'MM-dd hh:mm:ss');
                },
                formatNumber(number) {
                    if (number){
                        return number.toFixed(4);
                    }else{
                        return "0.0";
                    }
                }
            }
        });
        var ws = function (addr) {
            var that = this;
            that.state = "+open";
            that.addr = addr;
            that.open = function () {
                console.log("try open " + that.addr);
                that.socket = new WebSocket(that.addr);
                that.socket.onopen = that.onopen;
                that.socket.onclose = that.onclose;
                that.socket.onmessage = that.onmessage;
                that.socket.onerror = that.onerror;
            }

            that.onopen = function (e) {
                that.state = "+ok";
                console.log("opened " + that.addr);
                socket.send("+config");
            };
            that.onclose = function (e) {
                window.setTimeout(that.open, 500);
            };
            that.onmessage = function (e) {
                try {
                    var config = eval('(' + e.data + ')');
                    if (config != null) {
                        for (var idx = 0; idx < data.configs.length; idx++) {
                            var cfg = data.configs[idx];
                            if (cfg.station_name === config.station_name) {
                                Vue.set(data.configs, idx, config);
                                return;
                            }
                        }
                        data.configs.push(config);
                    }
                } catch (e) {

                }

            };
            that.onerror = function(e) {
                console.log("error: " + e.data);
                that.state = "+error";
            };
            return this;
        }
        var uri = "ws://" + location.host + "/ws";
        var socket = ws(uri);
        socket.open();

    </script>
}
<div id="vue" class="row">
    <template v-for="config in configs">
        <div class="col-md-3">
            
            <h2><a v-bind:href="'/Station?' + config.station_name">{{config.station_name}}</a></h2>
            @*<el-tooltip v-bind:content="config._description" placement="top" effect="light">
            </el-tooltip>*@
            <ul>
                <li>Alias</li>
                <template v-for="alia in config.station_alias">
                    {{alia}}
                </template>
                <li>Type:{{config.TypeName}}</li>
                <li>State:{{config.state}}</li>
                <li>ClientAddress</li>{{config.RequestAddress}}
                <li>WorkerAddress</li>{{config.WorkerAddress}}
                <li>Client</li>
                call: {{config.request_in}}
                <template v-if="config.request_out > 0">
                    result: {{config.request_out}}
                </template>
                <template v-if="config.request_err > 0">
                    err: {{config.request_err}}
                </template>
                <li>Wroker</li>call: {{config.worker_out}}
                <template v-if="config.worker_in > 0">
                    result: {{config.worker_in}}
                </template>
                <template v-if="config.worker_err > 0">
                    err: {{config.worker_err}}
                </template>
                <li>

                    Collection({{config.AvgQps}}|{{config.AvgTps}})
                    @*<ul>
            TPS
            <li>Total:{{config.TotalTps}}</li>
            <li>Avg:{{config.AvgTps}}/s</li>
            <li>Max:{{config.MaxTps}}/s</li>
            <li>Min:{{config.MinTps}}/s</li>
            <li>Last:{{config.LastTps}}/s</li>
        </ul>
        <ul>
            QPS
            <li>Total:{{config.TotalQps}}</li>
            <li>Avg:{{config.AvgQps}}/s</li>
            <li>Max:{{config.MaxQps}}/s</li>
            <li>Min:{{config.MinQps}}/s</li>
            <li>Last:{{config.LastQps}}/s</li>
        </ul>*@
                </li>
                <li>
                    <el-popover placement="right-end"
                                title="活动站点"
                                effect="light"
                                visible-arrow="false"
                                trigger="hover">
                        <template v-for="worker in config.workers">
                            <el-rate v-model="worker.level"
                                     disabled
                                     show-score
                                     text-color="#ff9900"
                                     score-template="{value}">
                            </el-rate>
                            {{worker.real_name}}:{{worker.state_text}}
                        </template>
                        <el-button slot="reference" type="text">Workers</el-button>
                    </el-popover>


                </li>

            </ul>
        </div>
    </template>
</div>